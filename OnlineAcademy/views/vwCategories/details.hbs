{{#section 'css'}}

{{!-- ----------- --}}
{{!-- Import ZONE --}}
{{!-- ----------- --}}

{{/section}}

{{#section 'js'}}

{{!-- ----------- --}}
{{!-- Import ZONE --}}
{{!-- ----------- --}}



<script>
    jQuery(document).ready(function () {
        (function () {
            var showChar = 400;
            var ellipsesText = "...";

            //jQuery(".truncate").each(function () {
            //    var content = jQuery(this);
            //    var contentHTML = content.html();
            //    if (contentHTML.length > showChar) {
            //        var truncateText = contentHTML.substr(0, showChar);
            //        var fullText = contentHTML;
            //        var html =
            //            '<div class="truncate-text" style="display:block">' + truncateText +
            //            ellipsesText +
            //            '<div class="container-fluid" style="display: flex; justify-content: center;">' +
            //            '<button type="button" class="btn btn-primary moreless more">Show More</a>' +
            //            '</div>' +
            //            '</div>' +
            //            '<div class="truncate-text" style="display:none">' + fullText +
            //            '<div class="container-fluid" style="display: flex; justify-content: center;">' +
            //            '<button type="button" class="btn btn-primary moreless less">Show Less</a>' +
            //            '</div>' +
            //            '</div>';

            //        content.html(html);
            //    }
            //});

            jQuery(".moreless").click(function () {
                var thisEl = jQuery(this);
                var tX = ".truncate-text";
                var cT = thisEl.closest(tX);

                if (thisEl.hasClass("less")) {
                    console.log("Less");
                    cT.toggle();
                    cT.prev(tX).fadeToggle();
                } else {
                    console.log("More");
                    cT.toggle();
                    cT.next(tX).fadeToggle();
                }
                return false;
            });
            /* end iffe */

            jQuery('.content-btn').on('click', function () {
                jQuery(this).next('.showContent').find('li').toggle();
            });

            size_li = jQuery("#feedback-list li").length;
            cur_show = 3;
            jQuery('#showless-btn').hide();
            jQuery('#feedback-list li:lt(' + cur_show + ')').show();

            jQuery('#showmore-btn').click(function () {
                cur_show = (cur_show + 5 <= size_li) ? cur_show + 5 : size_li;
                jQuery('#feedback-list li:lt(' + cur_show + ')').show();
                jQuery('#showless-btn').show();
                if (cur_show == size_li) {
                    jQuery('#showmore-btn').hide();
                }
            });

            jQuery('#showless-btn').click(function () {
                cur_show = (cur_show - 5 < 0) ? 3 : cur_show - 5;
                jQuery('#feedback-list li').not(':lt(' + cur_show + ')').hide();
                jQuery('#showmore-btn').show();
                jQuery('#showless-btn').show();
                if (cur_show == 3) {
                    jQuery('#showless-btn').hide();
                }
            });

            jQuery('textarea').on("input", function () {
                var maxlength = jQuery(this).attr("maxlength");
                var currentLength = jQuery(this).val().length;

                if (currentLength >= maxlength) {
                    jQuery('#char-number').text(
                        "You have reached the maximum number of characters.");
                } else {
                    jQuery('#char-number').text(maxlength - currentLength + " chars left");
                }
            });


        })();

        /* end ready */
    });
</script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
<script>
    function AddToWatchList(button) {
        const id = "{{detailCourse.id}}";
        $.post('/student/addToWatchList', {
            id: id
        }, function (data, status) {
            if (data) {
                swal("Add to watch list successfully!", {
                    icon: "success",
                    buttons: "OK",
                }).then(() => {
                    jQuery(button).remove();
                });
            } else {
                swal("Something is wrong, please try again!", {
                    icon: "error",
                    buttons: false,
                });
            }
        });
    }

    function BuyNow() {
        swal({
            title: "Are you sure?",
            text: "Please confirm your choice!",
            icon: "info",
            buttons: true,
        }).then((value) => {
            if (value) {
                const id = "{{detailCourse.id}}";
                $.post('/student/buyNow', {
                    id: id
                }, function (err, status) {
                    if (!err) {
                        swal("Buy successfully!", {
                            icon: "success",
                        }).then((value) => {
                            location.reload();
                        });
                    } else {
                        swal("Something is wrong, please try again!", {
                            icon: "error",
                        });
                    }
                });
            }

        });

    }
    function MarkAsComplete(button) {
        const sectionId = button.getAttribute("name");
        const courseId = "{{detailCourse.id}}";
        jQuery(button.parentNode).css("display", "none");
        jQuery(button.parentNode.parentNode).next().children("div").css("display", "");
        const data = {
            courseId: courseId,
            sectionId: sectionId,
            isComplete: true
        }
        $.post('/student/maskComplete', data, function (err, status) {
            console.log(err);
            if (!err) {
                const section = document.querySelector(`#list-btn[name="${sectionId}"]`);
                jQuery(section).css("background", "forestgreen");
                UpdateProgressBar(1);
            }
        });


    }
    function MarkAsInComplete(button) {
        const sectionId = button.getAttribute("name");
        const courseId = "{{detailCourse.id}}";
        jQuery(button.parentNode).css("display", "none");
        jQuery(button.parentNode.parentNode).prev().children("div").css("display", "");
        const data = {
            courseId: courseId,
            sectionId: sectionId,
            isComplete: false
        }
        $.post('/student/maskComplete', data, function (err, status) {
            console.log(err);
            if (!err) {
                const section = document.querySelector(`#list-btn[name="${sectionId}"]`);
                jQuery(section).css("background", "");
                UpdateProgressBar(-1);
            }
        });

    }
    function stopVideo(element) {

        var iframe = element.find('iframe')[0];
        var video = element.find('video')[0];

        if (iframe) {
            var iframeSrc = iframe.src;
            iframe.src = iframeSrc;
        }
        if (video) {
            video.pause();
        }

    }
    function UpdateProgressBar(add) {
        const progressBar = jQuery(".progress-bar");
        const currentProgress = progressBar.attr("aria-valuenow");
        const numberOfSection = "{{numberOfSection}}";
        var updateProgress = parseInt(currentProgress) + Math.round(add / numberOfSection * 100);
        updateProgress = updateProgress < 0 ? 0 : updateProgress > 100 ? 100 : updateProgress;
        progressBar.attr("aria-valuenow", updateProgress.toString());
        progressBar.css("width",updateProgress.toString()+"%");
        progressBar[0].innerHTML = updateProgress.toString() + "%";
    }

    function togglePopupVideo(video, activeState) {

        video = jQuery(video);
        video.toggleClass("active", activeState);
        if (!activeState) {
            stopVideo(video);
        }
    }
    function SubmitLike() {
        const courseId = "{{detailCourse.id}}";
        $.post('/student/like', { courseId: courseId }, function (err, data) {
            if (!err) {
                const likeElement = jQuery("#review-like");
                const likes = parseInt(likeElement.attr("value")) + 1;
                likeElement[0].innerHTML = "Likes " + likes + ", ";
                likeElement.attr("value",likes);
            }
        })
    }
    function SubmitFeedback(){
        const feedback = jQuery("#feedback-section").children('[name="userfeedback"]').val();
        const courseId = "{{detailCourse.id}}";
        $.post('/student/feedback', { feedback: feedback,courseId: courseId }, function (err, data) {
            if (!err) {
                swal("Send feedback successfully!", {
                    icon: "success",
                }).then((value) => {
                    location.reload();
                });
            }
            else {
                DisplayError(err.message);
            }
        });
    }
    function DisplayError(message) {
        swal({
            title: "Something is wrong",
            text: message,
            icon: "error",
            button: "Ok",
        });
    }
</script>

{{/section}}

<!-- Header -->
<header id="head" class="secondary">
    <div class="container">

        <h1>Courses</h1>
        <p>Lorem ipsum dolor sit amet, consectetur adipiscing eliras scele!</p>

    </div>
</header>
<!-- ./Header -->
<!-- Main -->
<!-- Main panel -->
<div class="container-fluid">
    <div class="row">

        <div class="col-md-3">
            <div class="panel panel-default sidebar-categories">
                <div class="panel-heading">Categories</div>

                <div class="list-group">
                    {{#each listCourseFields}}
                    {{#if this.isActive}}
                    <a href="/course/byField/{{this.name}}/?page=1" class="list-group-item active">
                        {{else}}
                        <a href="/course/byField/{{this.name}}/?page=1" class="list-group-item">
                            {{/if}}
                            <span class="badge">{{this.courseNumber}}</span>
                            {{this.name}}
                        </a>
                        {{/each}}
                </div>
            </div>
        </div>

        <div class="col-md-9">
            <div class="panel panel-default main-categories">
                <div class="panel-heading">Course Details</div>

                <div class="container-fluid">
                    <!-- Cover image -->
                    <div id="cover-image-detail" class="row">
                        <div class="container">
                            {{!-- <img class="img-responsive center-block" src="/resource/public/lecturer/1.png"
                                alt="Cover Image"> --}}
                            <img class="img-responsive center-block" src="{{detailCourse.imagePath}}" alt="Cover Image">
                            {{#if isAuthorized}}
                            {{#if (eq user.role 'student')}}
                            <div id="btn-list-detail" class="container-fluid">
                                {{#unless isInWatchList}}
                                <button id="add-to-wishlist-btn-detail" type="button" class="btn btn-primary"
                                    onclick="AddToWatchList(this)">
                                    Add to favorite&nbsp;
                                    <i class="fa fa-heart-o" aria-hidden="true"></i>
                                </button>
                                {{/unless}}
                                {{#unless isEnrolled}}
                                <!--{{#unless isInCart}}
                                <button id="add-to-cart-btn-detail" type="button" class="btn btn-primary">
                                    Add to cart&nbsp;
                                    <i class="fa fa-shopping-cart" aria-hidden="true"></i>
                                </button>
                                {{/unless}}-->
                                <button id="buy-now-btn-detail" type="button" class="btn btn-primary"
                                    onclick="BuyNow()">
                                    Buy now
                                </button>
                                {{/unless}}
                            </div>
                            {{/if}}
                            {{else}}
                            <div id="btn-list-detail" class="container-fluid">
                                <button id="add-to-wishlist-btn-detail" type="button" class="btn btn-primary"
                                    onclick="location.replace('/user/login')">
                                    Add to favorite&nbsp;
                                    <i class="fa fa-heart-o" aria-hidden="true"></i>
                                </button>
                                <!--<button id="add-to-cart-btn-detail" type="button" class="btn btn-primary"
                                    onclick="location.replace('/user/login')">
                                    Add to cart&nbsp;
                                    <i class="fa fa-shopping-cart" aria-hidden="true"></i>
                                </button>-->
                                <button id="buy-now-btn-detail" type="button" class="btn btn-primary"
                                    onclick="location.replace('/user/login')">
                                    Buy now
                                </button>
                            </div>
                            {{/if}}
                        </div>
                    </div>

                    <div id="course-info-detail" class="row">
                        <div class="container-fluid" id="details">

                            <h1>
                                Details
                            </h1>
                            {{#if isEnrolled}}
                            <a onclick="SubmitLike()" id="like-btn" class="btn btn-primary content-btn" role="button">
                                Like
                                <i class="fa fa-thumbs-up" aria-hidden="true"></i>
                            </a>
                            {{/if}}
                            <h2>
                                Information
                            </h2>
                            <div id="title">
                                {{detailCourse.title}}
                            </div>
                            <div id="tuition-fee">
                                $ {{detailCourse.price}}
                            </div>
                            <div id="short-description">
                                {{detailCourse.briefDescription}}
                            </div>
                            <div id="field">
                                {{detailCourse.fieldName}}
                            </div>
                            <div id="lecturer">
                                Created by
                                <a href="#lecturerInfo">{{lecturer.name}}</a>
                            </div>
                            <div id="review">
                                <i class="fa fa-eye" aria-hidden="true"></i> Views {{detailCourse.view}},&nbsp;
                                <i class="fa fa-heart-o" aria-hidden="true"></i> <div id="review-like" style="display:inline" value="{{detailCourse.likes}}"> Likes {{detailCourse.likes}},&nbsp; </div>
                                <i class="fa fa-user" aria-hidden="true"></i> Students {{detailCourse.enrollNumber}}
                            </div>
                            <div id="last-update">
                                Last updated {{detailCourse.lastUpdate}}
                            </div>

                            <h2>
                                Description
                            </h2>
                            <div id="description" class="truncate">
                                {{{detailCourse.description}}}
                            </div>

                            <h2>
                                Status
                            </h2>
                            <div id="status" class="truncate">
                                Complete
                            </div>
                        </div>

                        <div class="container-fluid" id="content">
                            <h1>
                                Content
                            </h1>
                            {{#if isEnrolled}}
                            <div class="progress">
                                <div class="progress-bar" role="progressbar" aria-valuenow="{{currentProgress}}" aria-valuemin="0"
                                    aria-valuemax="100" style="width: {{currentProgress}}%;">
                                    {{currentProgress}}%
                                </div>
                            </div>
                            {{/if}}
                            <h2>
                                {{detailCourse.briefDescription}}
                            </h2>

                            <p>
                                <i class="fa fa-circle-o" aria-hidden="true"></i>
                                {{detailCourse.totalHours}} hours
                                <i class="fa fa-circle-o" aria-hidden="true"></i>
                                {{numberOfSection}} sections
                            </p>

                            <div class="list-group">
                                {{#each listSections}}
                                <div class="list-item">
                                    {{#if isComplete}}
                                    <button type="button" id="list-btn" class="btn btn-primary content-btn" name="{{this.id}}" style="background:forestgreen">
                                        <i class="fa fa-angle-down pull-right" aria-hidden="true"></i>
                                        Section {{this.id}}
                                    </button>
                                    {{else}}
                                    <button type="button" id="list-btn" class="btn btn-primary content-btn" name="{{this.id}}">
                                        <i class="fa fa-angle-down pull-right" aria-hidden="true"></i>
                                        Section {{this.id}}
                                    </button>
                                    {{/if}}
                                    <ul class="showContent">
                                        <li>
                                            {{#with this.preview}}
                                            <div id="preview-duration{{../id}}" class="pull-right"></div>
                                            <a href="#currentvideo" onclick="togglePopupVideo(preview{{../id}}, true);">
                                                Preview
                                            </a>
                                            <div class="popupVideo" id="preview{{../id}}">
                                                <video src="{{../preview}}" type="video/mp4" controls="true"></video>
                                                <img src="/views/assets/images/closebutton.png" class="close-btn"
                                                    onclick="togglePopupVideo(preview{{../id}}, false);">
                                            </div>
                                            <script type="text/javascript">
                                                function RenderDuration(videoId, durationId) {
                                                    document.getElementById(`${videoId}`).children[0].onloadedmetadata =
                                                        function () {
                                                            const duration_s = this.duration;
                                                            const min = Math.floor(duration_s / 60);
                                                            const sec = Math.ceil(duration_s % 60);
                                                            const duration = min.toString().padStart(2, 0) + ':' + sec
                                                                .toString().padStart(2, 0);
                                                            document.getElementById(durationId).textContent = duration;
                                                        };
                                                }
                                                RenderDuration("preview{{../id}}", "preview-duration{{../id}}");
                                            </script>
                                            {{/with}}

                                        </li>
                                        <li>
                                            {{#if ../isEnrolled}}
                                            <div id="lecture-duration{{this.id}}" class="pull-right"></div>
                                            <a href="#currentvideo"
                                                onclick="togglePopupVideo(lecture{{this.id}}, true);">
                                                {{this.title}}
                                            </a>
                                            {{else}}
                                            <div id="lecture-duration{{this.id}}" class="pull-right"></div>
                                            {{this.title}}
                                            {{/if}}

                                            <div class="popupVideo" id="lecture{{this.id}}">
                                                <video
                                                    src="/resource/private/course/{{../detailCourse.id}}/{{this.id}}.mp4"
                                                    type="video/mp4" controls="true"></video>
                                                <img src="/views/assets/images/closebutton.png" class="close-btn"
                                                    onclick="togglePopupVideo(lecture{{this.id}}, false);">
                                            </div>

                                            <script type="text/javascript">
                                                function RenderDuration(videoId, durationId) {
                                                    document.getElementById(`${videoId}`).children[0].onloadedmetadata =
                                                        function () {
                                                            const duration_s = this.duration;
                                                            const min = Math.floor(duration_s / 60);
                                                            const sec = Math.ceil(duration_s % 60);
                                                            const duration = min.toString().padStart(2, 0) + ':' + sec
                                                                .toString().padStart(2, 0);
                                                            document.getElementById(durationId).textContent = duration;
                                                        };
                                                }
                                                RenderDuration("lecture{{this.id}}", "lecture-duration{{this.id}}");
                                            </script>
                                        </li>
                                        {{#if ../isEnrolled}}
                                        {{#if isComplete}}
                                        <li>
                                            <div id="mark-complete-container" class="container-fluid" style="display:none">
                                                <a id="mark-complete-btn" class="btn btn-primary content-btn" onclick="MarkAsComplete(this)" role="button" name="{{this.id}}">
                                                    Mark as complete
                                                </a>
                                            </div>
                                        </li>
                                        <li>
                                            <div id="mark-incomplete-container" class="container-fluid">
                                                <a id="mark-incomplete-btn" class="btn btn-primary content-btn" onclick="MarkAsInComplete(this)" role="button" name="{{this.id}}">
                                                    Mark as incomplete
                                                </a>
                                            </div>
                                        </li>
                                        {{else}}
                                        <li>
                                            <div id="mark-complete-container" class="container-fluid">
                                                <a id="mark-complete-btn" class="btn btn-primary content-btn" onclick="MarkAsComplete(this)" role="button" name="{{this.id}}">
                                                    Mark as complete
                                                </a>
                                            </div>
                                        </li>
                                        <li>
                                            <div id="mark-incomplete-container" class="container-fluid" style="display:none">
                                                <a id="mark-incomplete-btn" class="btn btn-primary content-btn" onclick="MarkAsInComplete(this)" role="button" name="{{this.id}}">
                                                    Mark as incomplete
                                                </a>
                                            </div>
                                        </li>
                                        {{/if}}
                                        {{/if}}
                                    </ul>
                                </div>
                                {{/each}}
                            </div>
                        </div>

                        <div class="container-fluid" id="related-courses">
                            <h1>
                                Related Courses
                            </h1>
                            {{#each relatedCourses}}
                            <div id="related-course" class="media">
                                <div id="related-course-img" class="pull-left">
                                    <img class="media-object" src="{{imagePath}}" alt="Hello">
                                    <a id="related-course-transaction-btn" href="/course/detail/{{id}}"
                                        class="btn btn-primary" role="button">
                                        Details
                                    </a>
                                </div>
                                <div class="media-body">
                                    <h4 class="media-heading">
                                        <div id="fee-related-course" class="pull-right">$ {{price}}</div>
                                        {{title}}
                                    </h4>
                                    <div id="description">
                                        {{briefDescription}}
                                    </div>
                                    <div id="field">
                                        {{fieldName}}
                                    </div>
                                    <div id="lecturers">
                                        {{lecturerName}}
                                    </div>
                                    <div id="reviews">
                                        <i class="fa fa-eye" aria-hidden="true"></i> Views {{view}},&nbsp;
                                        <i class="fa fa-heart-o" aria-hidden="true"></i> Likes {{likes}},&nbsp;
                                        <i class="fa fa-user" aria-hidden="true"></i> Students {{enrollNumber}}
                                    </div>
                                </div>
                            </div>
                            {{/each}}
                        </div>

                        <div class="container-fluid" id="lecturers">
                            <h1 id="lecturerInfo">
                                Lecturers
                            </h1>
                            {{#with lecturer}}
                            <div id="lecturer" class="media">
                                <div id="lecturer-img" class="pull-left">
                                    <img class="media-object" src="/resource/public/lecturer/{{id}}.png"
                                        alt="portfolio">
                                </div>
                                <div class="media-body">
                                    <h4 id="lecturer-name" class="media-heading">
                                        {{name}}
                                    </h4>
                                    <div id="lecturer-mail">
                                        <i class="fa fa-envelope-o" aria-hidden="true"></i>
                                        {{email}}
                                    </div>
                                    <div id="lecturer-phone">
                                        <i class="fa fa-phone" aria-hidden="true"></i>
                                        {{phone_number}}
                                    </div>
                                    <div id="lecturer-universe">
                                        <i class="fa fa-map-marker" aria-hidden="true"></i>
                                        {{university}}
                                    </div>
                                </div>
                            </div>
                            {{/with}}
                        </div>

                        <div class="container-fluid" id="feedbacks">
                            <h1>
                                Feedbacks
                            </h1>

                            {{#if isEnrolled}}
                            <div class="container-fluid" id="feedback-form">
                                <div class="row" id="user-name">
                                    <h3>
                                        {{user.name}}
                                    </h3>
                                </div>


                                <div class="row" id="feedback-section">
                                    <textarea name="userfeedback" class="form-control" rows="3" maxlength="1024"
                                        placeholder="Your feedback..."></textarea>
                                    <div id="char-number">1024 chars left</div>
                                </div>

                                <div class="row" id="form-submit-btn">
                                    <button onclick="SubmitFeedback()" class="btn btn-primary">Submit</button>
                                </div>


                            </div>
                            {{/if}}

                            <div class="container-fluid" id="feedbacks">
                                <ul class="list-group" id="feedback-list">
                                    {{#each listFeedbacks}}
                                    <li class="list-group-item">
                                        <h3>{{this.name}}</h3>
                                        <h4>{{this.date}}</h4>
                                        {{{this.comment}}}
                                    </li>
                                    {{/each}}
                                </ul>

                                <div id="showmore-btn" class="container-fluid">
                                    <button class="btn btn-primary">
                                        Show More
                                    </button>
                                </div>


                                <div id="showless-btn" class="container-fluid">
                                    <button class="btn btn-primary">
                                        Show Less
                                    </button>
                                </div>

                            </div>
                        </div>
                    </div>

                </div>

            </div>

        </div>

    </div>

</div>